name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  api-checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/api
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install uv
        run: pip install uv==0.4.18
      - name: Install deps
        run: |
          uv pip compile --generate-hashes pyproject.toml -o requirements.txt
          uv pip install --system -r requirements.txt
      - name: Ruff
        run: ruff check --output-format=github .
      - name: Mypy
        run: mypy src
      - name: Pytest with coverage
        run: |
          uv pip install --system pytest pytest-cov pytest-asyncio
          python -m pytest tests/ -v --cov=src --cov-report=xml --cov-fail-under=80
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: api
          fail_ci_if_error: false

  docker-build:
    runs-on: ubuntu-latest
    needs: api-checks
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build API image
        uses: docker/build-push-action@v6
        with:
          context: ./services/api
          push: false
          tags: apex-api:test
      - name: Build Worker image
        uses: docker/build-push-action@v6
        with:
          context: ./services/worker
          push: false
          tags: apex-worker:test

  acceptance:
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install uv and deps
        run: |
          pip install uv==0.4.18
          uv pip install --system schemathesis requests
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build API image (ci tag)
        uses: docker/build-push-action@v6
        with:
          context: ./services/api
          push: false
          tags: local/apex-api:ci
      - name: Compose up
        run: |
          docker compose -f infra/compose.yaml up -d --build
          for i in {1..60}; do curl -fsS http://localhost:8000/ready && break || sleep 3; done
      - name: Contract test (schemathesis)
        env:
          APEX_OPENAPI_URL: http://localhost:8000/openapi.json
        run: |
          python -m pytest -q tests/contract/test_openapi_contract.py
      - name: Envelope schema parity
        run: |
          python -m pytest -q tests/contract/test_envelope_schema.py
      - name: Rate limit gate
        run: |
          python -m pytest -q tests/contract/test_rate_limit.py
      - name: E2E tests
        run: |
          uv pip install --system httpx pytest pytest-asyncio
          docker compose -f docker-compose.test.yml up -d
          sleep 30  # Wait for services to be healthy
          python -m pytest tests/e2e/ -v --maxfail=3
          docker compose -f docker-compose.test.yml down -v
      - name: k6 smoke
        uses: grafana/k6-action@v0.3.1
        with:
          filename: tests/perf/k6_smoke.js
      - name: SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          path: .
          output-file: sbom.spdx.json
      - name: Trivy image scan (API)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: image
          image-ref: local/apex-api:ci
          format: table
          exit-code: '1'
          ignore-unfixed: true


