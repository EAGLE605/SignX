' ============================================
' MODERN SIGN FABRICATION EXPORT MACRO 2025
' Direct Integration with Current Industry Standards
' Labor Hours and Material Quantities Only
' ============================================

Option Explicit

' Department-specific data structures for 2025
Private Type ModernDesignData
    Complexity As String        ' Simple, Moderate, Complex
    PermitDrawings As Boolean
    Rendering3D As Boolean
    Revisions As Integer
    TotalHours As Double
End Type

Private Type ModernChannelLetterData
    LetterType As String        ' Standard, Reverse, Combo, Trimless
    FaceArea As Double         ' Square feet
    PeripheralFeet As Double   ' Actual perimeter
    LetterCount As Long
    ReturnDepth As Double      ' Inches
    MaterialRequired As Double  ' Total sq ft
    CoilRequired As Double     ' Linear feet
End Type

Private Type ModernCabinetData
    CabinetType As String      ' Raceway, SF-Cabinet, DF-Cabinet
    Width As Double
    Height As Double
    MountingType As String
    MaterialLinearFeet As Double
End Type

Private Type ModernElectricalData
    LEDType As String          ' Face-lit, Halo, Dual, RGB
    IlluminatedArea As Double
    ModuleCount As Long
    PowerSupplyCount As Long
    ControlSystem As String
End Type

' ============================================
' MAIN MODERN EXPORT FUNCTION
' ============================================
Sub ExportModernTakeoff()
    Dim selection As ShapeRange
    Dim outputPath As String
    Dim fileNum As Integer
    
    ' Check selection
    If ActiveSelectionRange.Count = 0 Then
        MsgBox "Please select sign elements to export", vbExclamation
        Exit Sub
    End If
    
    Set selection = ActiveSelectionRange
    
    ' Convert to curves first
    ConvertAllToCurves
    
    ' Generate all department data
    Dim designData As ModernDesignData
    Dim letterData As ModernChannelLetterData
    Dim cabinetData As ModernCabinetData
    Dim electricalData As ModernElectricalData
    
    ' Analyze selection with modern methods
    designData = AnalyzeModernDesign(selection)
    letterData = AnalyzeModernChannelLetters(selection)
    cabinetData = AnalyzeModernCabinet(selection)
    electricalData = AnalyzeModernElectrical(letterData.FaceArea)
    
    ' Create export file
    outputPath = CreateModernExportFile(designData, letterData, cabinetData, electricalData)
    
    ' Display summary
    ShowModernSummary designData, letterData, cabinetData, electricalData
    
    MsgBox "Modern takeoff data exported to:" & vbCrLf & outputPath, vbInformation
End Sub

' ============================================
' ANALYZE FOR MODERN DESIGN DEPARTMENT
' ============================================
Function AnalyzeModernDesign(sr As ShapeRange) As ModernDesignData
    Dim result As ModernDesignData
    
    ' Determine complexity based on shape count and nodes
    Dim totalNodes As Long
    Dim s As Shape
    
    For Each s In sr
        If s.Type = cdrCurveShape Then
            totalNodes = totalNodes + s.Curve.Nodes.Count
        End If
    Next s
    
    ' Modern complexity assessment
    If sr.Count < 10 And totalNodes < 500 Then
        result.Complexity = "Simple"
        result.TotalHours = 1#
    ElseIf sr.Count < 25 And totalNodes < 1500 Then
        result.Complexity = "Moderate"
        result.TotalHours = 2#
    Else
        result.Complexity = "Complex"
        result.TotalHours = 4#
    End If
    
    ' Default assumptions (user can modify)
    result.PermitDrawings = False
    result.Rendering3D = False
    result.Revisions = 2
    
    AnalyzeModernDesign = result
End Function

' ============================================
' ANALYZE MODERN CHANNEL LETTERS
' ============================================
Function AnalyzeModernChannelLetters(sr As ShapeRange) As ModernChannelLetterData
    Dim result As ModernChannelLetterData
    Dim s As Shape
    Dim totalArea As Double
    Dim totalPerimeter As Double
    
    result.LetterCount = 0
    result.ReturnDepth = 5 ' Standard 5" depth
    
    ' Analyze each letter using ACTUAL PERIMETER
    For Each s In sr
        If s.Type = cdrCurveShape Then
            ' Get actual area
            totalArea = totalArea + GetShapeArea(s)
            
            ' Get ACTUAL PERIMETER (not bounding box!)
            totalPerimeter = totalPerimeter + GetActualPerimeter(s)
            
            result.LetterCount = result.LetterCount + 1
        End If
    Next s
    
    ' Convert to appropriate units
    result.FaceArea = totalArea / 144 ' Convert to sq ft
    result.PeripheralFeet = totalPerimeter / 12 ' Convert to feet
    
    ' Calculate materials with waste factor
    result.MaterialRequired = result.FaceArea * 2 * 1.15 ' Double face + 15% waste
    result.CoilRequired = result.PeripheralFeet * 1.15 ' 15% waste
    
    ' Default to standard channel letters
    result.LetterType = "Standard Channel"
    
    AnalyzeModernChannelLetters = result
End Function

' ============================================
' GET ACTUAL PERIMETER (CRITICAL FUNCTION!)
' ============================================
Function GetActualPerimeter(s As Shape) As Double
    Dim perimeter As Double
    Dim seg As Segment
    Dim subPath As SubPath
    
    On Error Resume Next
    
    perimeter = 0
    
    If s.Type = cdrCurveShape Then
        ' THIS IS THE CRITICAL PART - ACTUAL CURVE LENGTH
        For Each subPath In s.Curve.SubPaths
            For Each seg In subPath.Segments
                perimeter = perimeter + seg.Length
            Next seg
        Next subPath
    End If
    
    ' Convert to inches
    GetActualPerimeter = perimeter * 0.0393701
End Function

' ============================================
' GET SHAPE AREA
' ============================================
Function GetShapeArea(s As Shape) As Double
    Dim area As Double
    
    On Error Resume Next
    
    If s.Type = cdrCurveShape Then
        area = s.Curve.Area
    ElseIf s.Type = cdrRectangleShape Then
        area = s.SizeWidth * s.SizeHeight
    ElseIf s.Type = cdrEllipseShape Then
        area = (s.SizeWidth / 2) * (s.SizeHeight / 2) * 3.14159
    End If
    
    ' Convert to square inches
    GetShapeArea = area * 0.0393701 * 0.0393701
End Function

' ============================================
' ANALYZE MODERN CABINET/RACEWAY
' ============================================
Function AnalyzeModernCabinet(sr As ShapeRange) As ModernCabinetData
    Dim result As ModernCabinetData
    
    ' Get overall dimensions
    result.Width = sr.SizeWidth * 0.0393701 / 12 ' Convert to feet
    result.Height = sr.SizeHeight * 0.0393701 / 12
    
    ' Calculate raceway length
    result.MaterialLinearFeet = result.Width
    
    ' Default types
    result.CabinetType = "Channel Letter Raceway"
    result.MountingType = "Structural Steel Mount"
    
    AnalyzeModernCabinet = result
End Function

' ============================================
' ANALYZE MODERN LED/ELECTRICAL
' ============================================
Function AnalyzeModernElectrical(faceArea As Double) As ModernElectricalData
    Dim result As ModernElectricalData
    
    result.IlluminatedArea = faceArea
    result.LEDType = "Face Lit"
    result.ControlSystem = "Standard On/Off"
    
    ' Modern LED calculations
    result.ModuleCount = CLng(WorksheetFunction.Ceiling(faceArea / 2, 1)) ' 1 module per 2 sq ft
    result.PowerSupplyCount = CLng(WorksheetFunction.Ceiling(faceArea / 30, 1)) ' 1 per 30 sq ft
    
    AnalyzeModernElectrical = result
End Function

' ============================================
' CREATE MODERN EXPORT FILE
' ============================================
Function CreateModernExportFile(design As ModernDesignData, letters As ModernChannelLetterData, _
    cabinet As ModernCabinetData, electrical As ModernElectricalData) As String
    
    Dim filePath As String
    Dim fileNum As Integer
    Dim content As String
    
    filePath = Application.Path & "\Modern_Sign_Takeoff_" & Format(Now, "yyyymmdd_hhmmss") & ".txt"
    fileNum = FreeFile
    
    ' Build export content
    content = "MODERN SIGN FABRICATION TAKEOFF - 2025 STANDARDS" & vbCrLf
    content = content & "Generated: " & Now & vbCrLf
    content = content & String(60, "=") & vbCrLf & vbCrLf
    
    ' Design/Art Department
    content = content & "[DESIGN/ART DEPARTMENT]" & vbCrLf
    content = content & "Complexity: " & design.Complexity & vbCrLf
    content = content & "Base Hours: " & Format(design.TotalHours, "0.00") & vbCrLf
    content = content & "Permit Drawings: " & IIf(design.PermitDrawings, "Yes (+2.0 hrs)", "No") & vbCrLf
    content = content & "3D Rendering: " & IIf(design.Rendering3D, "Yes (+1.5 hrs)", "No") & vbCrLf
    content = content & "Revisions: " & design.Revisions & vbCrLf & vbCrLf
    
    ' Channel Letters Department
    content = content & "[CHANNEL LETTER FABRICATION]" & vbCrLf
    content = content & "Letter Type: " & letters.LetterType & vbCrLf
    content = content & "Letter Count: " & letters.LetterCount & vbCrLf
    content = content & "Face Area: " & Format(letters.FaceArea, "0.00") & " sq ft (single face)" & vbCrLf
    content = content & "Peripheral Length: " & Format(letters.PeripheralFeet, "0.00") & " ft (ACTUAL PERIMETER)" & vbCrLf
    content = content & "Return Depth: " & letters.ReturnDepth & " inches" & vbCrLf
    content = content & "Material Required: " & Format(letters.MaterialRequired, "0.00") & " sq ft" & vbCrLf
    content = content & "Coil Required: " & Format(letters.CoilRequired, "0.00") & " linear ft" & vbCrLf & vbCrLf
    
    ' Cabinet/Raceway
    content = content & "[CABINET/RACEWAY]" & vbCrLf
    content = content & "Type: " & cabinet.CabinetType & vbCrLf
    content = content & "Dimensions: " & Format(cabinet.Width, "0.00") & " ft x " & Format(cabinet.Height, "0.00") & " ft" & vbCrLf
    content = content & "Mounting: " & cabinet.MountingType & vbCrLf
    content = content & "Raceway Length: " & Format(cabinet.MaterialLinearFeet, "0.00") & " ft" & vbCrLf & vbCrLf
    
    ' LED/Electrical
    content = content & "[LED/ELECTRICAL SYSTEMS]" & vbCrLf
    content = content & "Illumination Type: " & electrical.LEDType & vbCrLf
    content = content & "Illuminated Area: " & Format(electrical.IlluminatedArea, "0.00") & " sq ft" & vbCrLf
    content = content & "LED Modules: " & electrical.ModuleCount & " units" & vbCrLf
    content = content & "Power Supplies: " & electrical.PowerSupplyCount & " units" & vbCrLf
    content = content & "Control System: " & electrical.ControlSystem & vbCrLf & vbCrLf
    
    ' Labor hour summary (Modern rates)
    content = content & "[LABOR HOUR SUMMARY - 2025 RATES]" & vbCrLf
    Dim designHours As Double, channelHours As Double, electricalHours As Double
    Dim paintHours As Double, installHours As Double
    
    ' Calculate with modern efficiency
    designHours = design.TotalHours
    channelHours = 2# + (letters.FaceArea * 2 * 0.05) + (letters.PeripheralFeet * 0.08)
    electricalHours = 2# + (electrical.IlluminatedArea * 0.1)
    paintHours = 1# + (letters.MaterialRequired * 0.05)
    installHours = 36# ' From your actual estimate
    
    content = content & "Design/Art: " & Format(designHours, "0.00") & " hrs" & vbCrLf
    content = content & "Channel Letters: " & Format(channelHours, "0.00") & " hrs" & vbCrLf
    content = content & "LED/Electrical: " & Format(electricalHours, "0.00") & " hrs" & vbCrLf
    content = content & "Paint/Finish: " & Format(paintHours, "0.00") & " hrs" & vbCrLf
    content = content & "Installation: " & Format(installHours, "0.00") & " hrs" & vbCrLf
    content = content & "TOTAL: " & Format(designHours + channelHours + electricalHours + paintHours + installHours, "0.00") & " hrs" & vbCrLf
    
    ' Write file
    Open filePath For Output As fileNum
    Print #fileNum, content
    Close fileNum
    
    CreateModernExportFile = filePath
End Function

' ============================================
' SHOW MODERN SUMMARY
' ============================================
Sub ShowModernSummary(design As ModernDesignData, letters As ModernChannelLetterData, _
    cabinet As ModernCabinetData, electrical As ModernElectricalData)
    
    Dim msg As String
    
    msg = "MODERN SIGN TAKEOFF SUMMARY (2025)" & vbCrLf & vbCrLf
    
    msg = msg & "CHANNEL LETTERS:" & vbCrLf
    msg = msg & "Count: " & letters.LetterCount & vbCrLf
    msg = msg & "Face Area: " & Format(letters.FaceArea, "0.00") & " sq ft" & vbCrLf
    msg = msg & "Perimeter: " & Format(letters.PeripheralFeet, "0.00") & " ft (actual)" & vbCrLf
    msg = msg & "Material: " & Format(letters.MaterialRequired, "0.00") & " sq ft" & vbCrLf
    msg = msg & "Coil: " & Format(letters.CoilRequired, "0.00") & " ft" & vbCrLf & vbCrLf
    
    msg = msg & "LED SYSTEM:" & vbCrLf
    msg = msg & "Modules: " & electrical.ModuleCount & vbCrLf
    msg = msg & "Power Supplies: " & electrical.PowerSupplyCount & vbCrLf & vbCrLf
    
    msg = msg & "EFFICIENCY NOTE:" & vbCrLf
    msg = msg & "Modern CNC routing and automated bending" & vbCrLf
    msg = msg & "reduce fabrication time by 30-40%" & vbCrLf
    msg = msg & "compared to traditional methods."
    
    MsgBox msg, vbInformation, "Modern Takeoff Summary"
End Sub

' ============================================
' QUICK COMPARISON TOOLS
' ============================================
Sub ComparePerimeterMethods()
    ' Shows difference between bounding box and actual perimeter
    If ActiveSelectionRange.Count = 1 Then
        Dim s As Shape
        Set s = ActiveSelectionRange(1)
        
        If s.Type = cdrCurveShape Then
            Dim boundingPerimeter As Double
            Dim actualPerimeter As Double
            
            ' Bounding box perimeter
            boundingPerimeter = 2 * (s.SizeWidth + s.SizeHeight) * 0.0393701
            
            ' Actual perimeter
            actualPerimeter = GetActualPerimeter(s)
            
            Dim msg As String
            msg = "PERIMETER COMPARISON" & vbCrLf & vbCrLf
            msg = msg & "Bounding Box: " & Format(boundingPerimeter / 12, "0.00") & " ft" & vbCrLf
            msg = msg & "Actual Path: " & Format(actualPerimeter / 12, "0.00") & " ft" & vbCrLf
            msg = msg & "Difference: " & Format(((actualPerimeter - boundingPerimeter) / boundingPerimeter) * 100, "0.0") & "%" & vbCrLf & vbCrLf
            msg = msg & "ALWAYS use actual perimeter for coil calculations!"
            
            MsgBox msg, vbInformation
        End If
    End If
End Sub

' ============================================
' MATERIAL OPTIMIZATION REPORT
' ============================================
Sub GenerateMaterialOptimization()
    Dim sr As ShapeRange
    Set sr = ActiveSelectionRange
    
    Dim letterData As ModernChannelLetterData
    letterData = AnalyzeModernChannelLetters(sr)
    
    Dim report As String
    report = "MATERIAL OPTIMIZATION REPORT" & vbCrLf & vbCrLf
    
    ' Standard sheet sizes
    Dim sheets48x96 As Integer
    Dim sheets48x120 As Integer
    Dim sheets60x120 As Integer
    
    ' Calculate optimal sheet usage
    sheets48x96 = WorksheetFunction.Ceiling(letterData.MaterialRequired / 32, 1)
    sheets48x120 = WorksheetFunction.Ceiling(letterData.MaterialRequired / 40, 1)
    sheets60x120 = WorksheetFunction.Ceiling(letterData.MaterialRequired / 50, 1)
    
    report = report & "Material Required: " & Format(letterData.MaterialRequired, "0.00") & " sq ft" & vbCrLf & vbCrLf
    report = report & "SHEET OPTIONS:" & vbCrLf
    report = report & "4' x 8' sheets: " & sheets48x96 & " (" & Format((sheets48x96 * 32 - letterData.MaterialRequired) / (sheets48x96 * 32) * 100, "0.0") & "% waste)" & vbCrLf
    report = report & "4' x 10' sheets: " & sheets48x120 & " (" & Format((sheets48x120 * 40 - letterData.MaterialRequired) / (sheets48x120 * 40) * 100, "0.0") & "% waste)" & vbCrLf
    report = report & "5' x 10' sheets: " & sheets60x120 & " (" & Format((sheets60x120 * 50 - letterData.MaterialRequired) / (sheets60x120 * 50) * 100, "0.0") & "% waste)" & vbCrLf & vbCrLf
    
    report = report & "COIL OPTIMIZATION:" & vbCrLf
    report = report & "Required: " & Format(letterData.CoilRequired, "0.00") & " ft" & vbCrLf
    report = report & "Standard 250' coil: " & WorksheetFunction.Ceiling(letterData.CoilRequired / 250, 1) & " rolls" & vbCrLf
    report = report & "Standard 500' coil: " & WorksheetFunction.Ceiling(letterData.CoilRequired / 500, 1) & " rolls" & vbCrLf
    
    DisplayResults report
End Sub

' ============================================
' DISPLAY RESULTS IN CORELDRAW
' ============================================
Sub DisplayResults(results As String)
    Dim textShape As Shape
    Dim doc As Document
    
    Set doc = ActiveDocument
    Set textShape = ActiveLayer.CreateArtisticText(0, doc.SizeHeight, results)
    textShape.Text.FontProperties.Size = 12
    textShape.Text.FontProperties.Name = "Arial"
End Sub