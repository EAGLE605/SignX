' COMPLETE UNIVERSAL DIAGNOSTIC TOOL WITH ALL FUNCTIONS
' This version includes all the diagnostic functions that were missing

Option Explicit

' Storage for user's preferred save path
Private SavePath As String

' ===================== ONE-CLICK SETUP & RUN =====================
Sub RunDiagnosticTool()
    ' This is the ONLY macro users need to run
    ' It handles setup on first run, then runs diagnostic
    
    Dim reportPath As String
    
    ' Check if save path is configured
    reportPath = GetSavePath()
    
    If reportPath = "" Then
        ' First time - show welcome and setup
        ShowWelcomeAndSetup
        reportPath = GetSavePath()
        
        ' If still no path, user cancelled
        If reportPath = "" Then
            MsgBox "Diagnostic cancelled. Run again when ready to choose a save location.", vbInformation
            Exit Sub
        End If
    End If
    
    ' Run the diagnostic
    ExecuteDiagnostic reportPath
End Sub

' ===================== WELCOME & SETUP =====================
Sub ShowWelcomeAndSetup()
    Dim msg As String
    
    msg = "WELCOME TO CORELDRAW DIAGNOSTIC TOOL!" & vbCrLf & vbCrLf
    msg = msg & "This tool will create detailed reports about your CorelDRAW setup." & vbCrLf & vbCrLf
    msg = msg & "First, you need to choose where to save your reports." & vbCrLf & vbCrLf
    msg = msg & "Popular choices:" & vbCrLf
    msg = msg & "• Desktop (easy to find)" & vbCrLf
    msg = msg & "• Documents folder" & vbCrLf
    msg = msg & "• Custom project folder" & vbCrLf & vbCrLf
    msg = msg & "Click OK to choose your folder..."
    
    MsgBox msg, vbInformation, "Welcome - First Time Setup"
    
    ' Let user choose path
    ChooseSavePath
End Sub

' ===================== PATH SELECTION =====================
Sub ChooseSavePath()
    Dim choice As String
    Dim customPath As String
    
    choice = InputBox("WHERE TO SAVE DIAGNOSTIC REPORTS?" & vbCrLf & vbCrLf & _
                     "Choose an option:" & vbCrLf & vbCrLf & _
                     "1 = Desktop (Recommended)" & vbCrLf & _
                     "2 = Documents folder" & vbCrLf & _
                     "3 = Current CorelDRAW folder" & vbCrLf & _
                     "4 = Custom location (browse)" & vbCrLf & vbCrLf & _
                     "Enter 1, 2, 3, or 4:", "Choose Save Location", "1")
    
    Select Case choice
        Case "1" ' Desktop
            SavePath = CreateObject("WScript.Shell").SpecialFolders("Desktop")
            
        Case "2" ' Documents
            SavePath = CreateObject("WScript.Shell").SpecialFolders("MyDocuments")
            
        Case "3" ' CorelDRAW folder
            SavePath = Application.Path
            
        Case "4" ' Custom - Use folder browser
            customPath = BrowseForFolder("Select where to save diagnostic reports:")
            
            If customPath <> "" Then
                SavePath = customPath
            Else
                ' Default to Desktop if cancelled
                SavePath = CreateObject("WScript.Shell").SpecialFolders("Desktop")
                MsgBox "No folder selected. Using Desktop instead.", vbInformation
            End If
            
        Case Else
            ' Default to Desktop
            SavePath = CreateObject("WScript.Shell").SpecialFolders("Desktop")
    End Select
    
    ' Create folder if needed
    CreateFolderIfNeeded SavePath & "\CorelDRAW Diagnostics"
    SavePath = SavePath & "\CorelDRAW Diagnostics"
    
    ' Save the path for future use
    SaveSetting "CorelDRAWDiagnostic", "Settings", "SavePath", SavePath
    
    ' Confirm to user
    MsgBox "Reports will be saved to:" & vbCrLf & vbCrLf & _
           SavePath & vbCrLf & vbCrLf & _
           "You can change this later by running 'ChangeDiagnosticPath'", _
           vbInformation, "Save Location Set"
End Sub

' ===================== BROWSE FOR FOLDER =====================
Function BrowseForFolder(title As String) As String
    ' Shows Windows folder browser dialog
    Dim objShell As Object
    Dim objFolder As Object
    Dim folderPath As String
    
    On Error Resume Next
    
    ' Create Shell object
    Set objShell = CreateObject("Shell.Application")
    
    ' Show folder browser
    ' &H0 = Default, &H1 = Only file system folders, &H10 = Include edit box
    Set objFolder = objShell.BrowseForFolder(0, title, &H1 + &H10)
    
    ' Get selected path
    If Not objFolder Is Nothing Then
        folderPath = objFolder.Self.Path
        BrowseForFolder = folderPath
    Else
        BrowseForFolder = ""
    End If
    
    ' Clean up
    Set objFolder = Nothing
    Set objShell = Nothing
    
    On Error GoTo 0
End Function

' ===================== GET SAVED PATH =====================
Function GetSavePath() As String
    ' Retrieve saved path from registry
    On Error Resume Next
    GetSavePath = GetSetting("CorelDRAWDiagnostic", "Settings", "SavePath", "")
    On Error GoTo 0
End Function

' ===================== CHANGE PATH (Optional) =====================
Sub ChangeDiagnosticPath()
    ' Let users change their save location
    Dim currentPath As String
    currentPath = GetSavePath()
    
    If currentPath <> "" Then
        MsgBox "Current save location:" & vbCrLf & currentPath, vbInformation, "Current Path"
    End If
    
    ChooseSavePath
End Sub

' ===================== EXECUTE DIAGNOSTIC =====================
Sub ExecuteDiagnostic(savePath As String)
    Dim report As String
    Dim fileName As String
    Dim fullPath As String
    
    ' Generate filename with date
    fileName = Format(Date, "mmddyy") & " Diagnostic Report.txt"
    fullPath = savePath & "\" & fileName
    
    ' Show progress
    MsgBox "Generating diagnostic report..." & vbCrLf & vbCrLf & _
           "This will be saved to:" & vbCrLf & _
           fullPath, vbInformation, "Starting Diagnostic"
    
    ' Generate report
    report = GenerateCompleteDiagnosticReport()
    
    ' Save report
    If SaveReportToFile(report, fullPath) Then
        ' Success
        MsgBox "Diagnostic complete!" & vbCrLf & vbCrLf & _
               "Report saved to:" & vbCrLf & _
               fullPath & vbCrLf & vbCrLf & _
               "Size: " & Format(Len(report), "#,##0") & " characters", _
               vbInformation, "Success"
        
        ' Offer to open
        If MsgBox("Open the report now?", vbYesNo + vbQuestion) = vbYes Then
            Shell "notepad.exe """ & fullPath & """", vbNormalFocus
        End If
        
        ' Offer to open folder
        If MsgBox("Open the folder?", vbYesNo + vbQuestion) = vbYes Then
            Shell "explorer.exe """ & savePath & """", vbNormalFocus
        End If
    Else
        MsgBox "Error saving report. Check permissions for:" & vbCrLf & savePath, vbExclamation
    End If
End Sub

' ===================== CREATE FOLDER =====================
Sub CreateFolderIfNeeded(folderPath As String)
    On Error Resume Next
    Dim fso As Object
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    If Not fso.FolderExists(folderPath) Then
        fso.CreateFolder folderPath
    End If
    On Error GoTo 0
End Sub

' ===================== REPORT GENERATION =====================
Function GenerateCompleteDiagnosticReport() As String
    Dim report As String
    Dim sectionBreak As String
    sectionBreak = vbCrLf & String(80, "=") & vbCrLf & vbCrLf
    
    report = "CORELDRAW DIAGNOSTIC REPORT" & vbCrLf
    report = report & "Generated: " & Now & vbCrLf
    report = report & "Computer: " & Environ("COMPUTERNAME") & vbCrLf
    report = report & "User: " & Environ("USERNAME") & vbCrLf
    report = report & String(80, "=") & vbCrLf & vbCrLf
    
    ' Add all diagnostic sections
    report = report & "1. APPLICATION INFORMATION" & sectionBreak
    report = report & GetApplicationInfo()
    
    report = report & "2. SYSTEM CONFIGURATION" & sectionBreak
    report = report & GetSystemConfig()
    
    report = report & "3. DOCUMENT ANALYSIS" & sectionBreak
    report = report & GetDocumentAnalysis()
    
    report = report & "4. PRINTER CONFIGURATION" & sectionBreak
    report = report & GetPrinterInfo()
    
    report = report & "5. COLOR MANAGEMENT" & sectionBreak
    report = report & GetColorManagementInfo()
    
    report = report & "6. FONT INFORMATION" & sectionBreak
    report = report & GetFontInfo()
    
    report = report & "7. WORKSPACE SETTINGS" & sectionBreak
    report = report & GetWorkspaceInfo()
    
    report = report & "8. RECENT FILES" & sectionBreak
    report = report & GetRecentFiles()
    
    GenerateCompleteDiagnosticReport = report
End Function

' ===================== SAVE REPORT =====================
Function SaveReportToFile(content As String, filePath As String) As Boolean
    On Error GoTo SaveError
    
    Dim fileNum As Integer
    fileNum = FreeFile
    
    Open filePath For Output As #fileNum
    Print #fileNum, content
    Close #fileNum
    
    SaveReportToFile = True
    Exit Function
    
SaveError:
    SaveReportToFile = False
End Function

' ===================== DIAGNOSTIC FUNCTIONS =====================

Function GetApplicationInfo() As String
    Dim info As String
    On Error Resume Next
    
    info = "CorelDRAW Version: " & Application.Version & vbCrLf
    info = info & "Build: " & Application.Build & vbCrLf
    info = info & "Edition: " & Application.Edition & vbCrLf
    info = info & "Language: " & Application.LanguageCode & vbCrLf
    info = info & "Installation Path: " & Application.Path & vbCrLf
    info = info & "Data Path: " & Application.DataPath & vbCrLf
    info = info & "Start Time: " & Application.StartupTime & vbCrLf
    info = info & "Memory Usage: " & Format(Application.MemoryUsage / 1024 / 1024, "#,##0.0") & " MB" & vbCrLf
    
    On Error GoTo 0
    GetApplicationInfo = info
End Function

Function GetSystemConfig() As String
    Dim info As String
    On Error Resume Next
    
    info = "Operating System: " & Application.OperatingSystem & vbCrLf
    info = info & "Windows Version: " & Environ("OS") & vbCrLf
    info = info & "Computer Name: " & Environ("COMPUTERNAME") & vbCrLf
    info = info & "User Name: " & Environ("USERNAME") & vbCrLf
    info = info & "User Domain: " & Environ("USERDOMAIN") & vbCrLf
    info = info & "Processor: " & Environ("PROCESSOR_IDENTIFIER") & vbCrLf
    info = info & "Number of Processors: " & Environ("NUMBER_OF_PROCESSORS") & vbCrLf
    info = info & "System Architecture: " & Environ("PROCESSOR_ARCHITECTURE") & vbCrLf
    info = info & "Temp Folder: " & Environ("TEMP") & vbCrLf
    
    On Error GoTo 0
    GetSystemConfig = info
End Function

Function GetDocumentAnalysis() As String
    Dim info As String
    Dim doc As Document
    On Error Resume Next
    
    If Documents.Count = 0 Then
        info = "No documents currently open" & vbCrLf
    Else
        Set doc = ActiveDocument
        info = "Active Document: " & doc.Name & vbCrLf
        info = info & "File Path: " & doc.FilePath & vbCrLf
        info = info & "Pages: " & doc.Pages.Count & vbCrLf
        info = info & "Active Page: " & doc.ActivePage.Name & vbCrLf
        info = info & "Unit: " & doc.Unit & vbCrLf
        info = info & "Resolution: " & doc.Resolution & " DPI" & vbCrLf
        info = info & "Color Mode: " & doc.ColorMode & vbCrLf
        info = info & "Modified: " & IIf(doc.Dirty, "Yes", "No") & vbCrLf
        info = info & "Read Only: " & IIf(doc.ReadOnly, "Yes", "No") & vbCrLf
        
        ' Count objects
        Dim totalShapes As Long
        Dim pg As Page
        For Each pg In doc.Pages
            totalShapes = totalShapes + pg.Shapes.Count
        Next pg
        info = info & "Total Objects: " & totalShapes & vbCrLf
    End If
    
    On Error GoTo 0
    GetDocumentAnalysis = info
End Function

Function GetPrinterInfo() As String
    Dim info As String
    On Error Resume Next
    
    With Application.PrintSettings
        info = "Current Printer: " & .Printer & vbCrLf
        info = info & "Paper Size: " & .PaperSize & vbCrLf
        info = info & "Orientation: " & .Orientation & vbCrLf
        info = info & "Copies: " & .Copies & vbCrLf
        info = info & "Collate: " & .Collate & vbCrLf
        info = info & "Color Mode: " & .ColorMode & vbCrLf
        info = info & "Resolution: " & .Resolution & " DPI" & vbCrLf
    End With
    
    ' List available printers
    info = info & vbCrLf & "Available Printers:" & vbCrLf
    Dim prt As Printer
    For Each prt In Application.Printers
        info = info & "  - " & prt.Name & vbCrLf
    Next prt
    
    On Error GoTo 0
    GetPrinterInfo = info
End Function

Function GetColorManagementInfo() As String
    Dim info As String
    On Error Resume Next
    
    With Application.ColorManager
        info = "Color Management Enabled: " & .Enabled & vbCrLf
        info = info & "RGB Profile: " & .RGBProfile & vbCrLf
        info = info & "CMYK Profile: " & .CMYKProfile & vbCrLf
        info = info & "Grayscale Profile: " & .GrayscaleProfile & vbCrLf
        info = info & "Rendering Intent: " & .RenderingIntent & vbCrLf
    End With
    
    On Error GoTo 0
    GetColorManagementInfo = info
End Function

Function GetFontInfo() As String
    Dim info As String
    Dim fontCount As Long
    On Error Resume Next
    
    fontCount = Application.FontList.Count
    info = "Total Fonts Installed: " & fontCount & vbCrLf & vbCrLf
    
    ' List first 20 fonts
    info = info & "Sample Fonts (first 20):" & vbCrLf
    Dim i As Long
    For i = 1 To IIf(fontCount > 20, 20, fontCount)
        info = info & "  " & i & ". " & Application.FontList(i) & vbCrLf
    Next i
    
    If fontCount > 20 Then
        info = info & "  ... and " & (fontCount - 20) & " more fonts" & vbCrLf
    End If
    
    On Error GoTo 0
    GetFontInfo = info
End Function

Function GetWorkspaceInfo() As String
    Dim info As String
    On Error Resume Next
    
    info = "Current Workspace: " & Application.ActiveWorkspace & vbCrLf
    info = info & "UI Language: " & Application.UILanguage & vbCrLf
    
    ' Get window state
    With Application.ActiveWindow
        info = info & "Window State: " & .WindowState & vbCrLf
        info = info & "Zoom Level: " & Format(.ActiveView.Zoom, "0.0") & "%" & vbCrLf
    End With
    
    On Error GoTo 0
    GetWorkspaceInfo = info
End Function

Function GetRecentFiles() As String
    Dim info As String
    Dim i As Long
    On Error Resume Next
    
    info = "Recent Files:" & vbCrLf
    For i = 1 To Application.RecentFiles.Count
        If i > 10 Then Exit For ' Limit to 10 files
        info = info & "  " & i & ". " & Application.RecentFiles(i) & vbCrLf
    Next i
    
    If Application.RecentFiles.Count = 0 Then
        info = info & "  (No recent files)" & vbCrLf
    End If
    
    On Error GoTo 0
    GetRecentFiles = info
End Function

' ===================== ONE-CLICK INSTALLER =====================
Sub InstallDiagnosticTool()
    ' This sets everything up with one click
    Dim msg As String
    
    msg = "DIAGNOSTIC TOOL INSTALLER" & vbCrLf & vbCrLf
    msg = msg & "This will:" & vbCrLf
    msg = msg & "1. Set up the diagnostic tool" & vbCrLf
    msg = msg & "2. Create a toolbar button" & vbCrLf
    msg = msg & "3. Let you choose where to save reports" & vbCrLf & vbCrLf
    msg = msg & "Continue?"
    
    If MsgBox(msg, vbYesNo + vbQuestion, "Install Diagnostic Tool") = vbNo Then
        Exit Sub
    End If
    
    ' Get save location
    ShowWelcomeAndSetup
    
    ' Create toolbar button
    On Error Resume Next
    Dim cb As CommandBar
    Dim btn As CommandBarButton
    
    ' Remove old button if exists
    Application.CommandBars("Diagnostic Tool").Delete
    
    ' Create new toolbar
    Set cb = Application.CommandBars.Add("Diagnostic Tool", msoBarTop, False, True)
    
    ' Add button
    Set btn = cb.Controls.Add(msoControlButton)
    btn.Caption = "Run Diagnostic"
    btn.FaceId = 487
    btn.OnAction = "RunDiagnosticTool"
    btn.TooltipText = "Generate diagnostic report"
    btn.Style = msoButtonIconAndCaption
    
    cb.Visible = True
    On Error GoTo 0
    
    ' Success message
    MsgBox "Installation complete!" & vbCrLf & vbCrLf & _
           "• Reports will save to: " & GetSavePath() & vbCrLf & _
           "• Toolbar button added" & vbCrLf & vbCrLf & _
           "Click the 'Run Diagnostic' button anytime!", _
           vbInformation, "Success"
End Sub