x-common-env: &common_env
  PYTHONUNBUFFERED: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  ENV_FILE: .env
  APEX_ENV: dev

services:
  api:
    build:
      context: ..
      dockerfile: infra/docker/Dockerfile.api
    command: [
      "uvicorn", "apex.api.main:app",
      "--host", "0.0.0.0",
      "--port", "8000",
      "--proxy-headers",
      "--forwarded-allow-ips=*",
      "--limit-max-requests", "10000",
      "--timeout-keep-alive", "5"
    ]
    env_file:
      - ../.env
    environment:
      <<: *common_env
      SERVICE_NAME: api
      PORT: "8000"
    volumes:
      - ../services/api:/app/services/api
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request,sys; urllib.request.urlopen('http://localhost:8000/ready'); sys.exit(0)"]
      interval: 5s
      timeout: 2s
      retries: 20
    depends_on:
      cache:
        condition: service_healthy

  worker:
    build:
      context: ..
      dockerfile: infra/docker/Dockerfile.worker
    command: ["python", "-m", "apex.worker.main"]
    env_file:
      - ../.env
    environment:
      <<: *common_env
      SERVICE_NAME: worker
      CELERY_BROKER_URL: redis://cache:6379/0
      CELERY_RESULT_BACKEND: redis://cache:6379/1
    volumes:
      - ../services/worker:/app/services/worker
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 3s
      retries: 3
    depends_on:
      cache:
        condition: service_healthy

  cache:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "PING"]
      interval: 5s
      timeout: 2s
      retries: 20

  # optional pgvector (enabled later)
  db:
    image: pgvector/pgvector:pg16
    profiles: ["db"]
    environment:
      POSTGRES_PASSWORD: apex
      POSTGRES_USER: apex
      POSTGRES_DB: apex
    ports: ["5432:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U apex -d apex"]
      interval: 5s
      timeout: 2s
      retries: 30
    # disabled by default via profile

  opensearch:
    image: opensearchproject/opensearch:2
    profiles: ["search"]
    environment:
      discovery.type: single-node
    ports:
      - "9200:9200"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  minio:
    image: minio/minio:latest
    profiles: ["storage"]
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5


