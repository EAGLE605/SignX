# ============================================================================
# Test Environment Dockerfile - Isolated test environment with pinned dependencies
# ============================================================================
FROM python:3.11-slim

LABEL maintainer="SignX Studio Engineering <engineering@signxstudio.com>"
LABEL description="SignX Studio API - Test Environment (pytest + coverage)"
LABEL version="1.0.0"

# Test environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PYTHONHASHSEED=0 \
    PYTHONPATH=/app/src \
    TESTING=1

# Create non-root user
RUN groupadd -r testuser -g 1000 && \
    useradd -r -u 1000 -g testuser -d /app -s /bin/bash testuser && \
    mkdir -p /app /tmp/apex /var/log/apex && \
    chown -R testuser:testuser /app /tmp/apex /var/log/apex

WORKDIR /app

# Install system dependencies (including build tools for compiling extensions)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    libpq-dev \
    curl \
    ca-certificates \
    git \
    && rm -rf /var/lib/apt/lists/* && \
    apt-get clean

# Install uv package manager
RUN pip install --upgrade pip && \
    pip install uv==0.4.18

# Copy pyproject.toml with dependencies
COPY --chown=testuser:testuser pyproject.toml /app/pyproject.toml

# Install all dependencies (production + dev) with pinned versions
RUN uv pip install --system --no-cache \
    # Production dependencies
    fastapi==0.111.0 \
    uvicorn[standard]==0.30.1 \
    pydantic==2.8.2 \
    pint==0.24.3 \
    numpy==1.26.4 \
    scipy==1.11.4 \
    scikit-learn==1.4.1.post1 \
    deap==1.4.1 \
    matplotlib==3.9.0 \
    jinja2==3.1.3 \
    weasyprint==61.2 \
    pandas==2.2.1 \
    structlog==24.1.0 \
    orjson==3.10.7 \
    pydantic-settings==2.4.0 \
    redis==5.0.4 \
    asyncpg==0.29.0 \
    aiohttp==3.9.5 \
    httpx==0.27.0 \
    celery==5.4.0 \
    prometheus-fastapi-instrumentator==6.1.0 \
    prometheus-client==0.20.0 \
    slowapi==0.1.9 \
    opentelemetry-sdk==1.26.0 \
    opentelemetry-exporter-otlp==1.26.0 \
    opentelemetry-instrumentation-fastapi==0.47b0 \
    opentelemetry-instrumentation-logging==0.47b0 \
    SQLAlchemy==2.0.34 \
    alembic==1.13.2 \
    pyyaml==6.0.2 \
    openpyxl==3.1.5 \
    psycopg2-binary==2.9.9 \
    minio==7.2.8 \
    python-jose[cryptography]==3.3.0 \
    python-multipart==0.0.9 \
    sentry-sdk[fastapi]==2.19.0 \
    supabase==2.3.4 \
    duo-client==5.3.0 \
    bcrypt==4.2.0 \
    tenacity==8.2.3 \
    passlib[bcrypt]==1.7.4 \
    zxcvbn==4.4.28 \
    # Dev/test dependencies
    pytest==8.2.2 \
    pytest-asyncio==0.23.7 \
    pytest-benchmark==4.0.0 \
    pytest-cov==5.0.0 \
    httpx==0.27.0 \
    schemathesis==3.26.0 \
    ruff==0.5.6 \
    mypy==1.11.1

# Copy application code
COPY --chown=testuser:testuser src /app/src
COPY --chown=testuser:testuser tests /app/tests
COPY --chown=testuser:testuser alembic /app/alembic
COPY --chown=testuser:testuser alembic.ini /app/alembic.ini
COPY --chown=testuser:testuser config /app/config

# Switch to non-root user
USER testuser

# Default command: run pytest with coverage
CMD ["pytest", "-v", "--tb=short", "--cov=apex", "--cov-report=term-missing", "--cov-report=html"]
